<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>月次タイヤ点検表</title>
  <meta name="description" content="大型トラック向けの月次タイヤ点検Webアプリ">
  <meta name="theme-color" content="#1f4b73">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="タイヤ点検">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/tire-192.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/tire-192.png">
  <style>
    :root {
      --bg: #f4f8fd;
      --bg2: #d9e8f8;
      --surface: #ffffff;
      --surface2: #eef4fb;
      --text: #0f1b2a;
      --text-strong: #08121d;
      --muted: #4c637d;
      --line: #b4c8df;
      --accent: #2f78bf;
      --ok: #2f9d69;
      --warn: #b7792e;
      --pending: #6f879f;
      --danger: #b24b4b;
      --dock-bg: #dbe7f5;
      --dock-surface: #edf4fc;
      --dock-line: #b8cade;
      --tap: 56px;
      --radius: 12px;
      --shadow: 0 10px 24px rgba(20, 44, 72, 0.18);
    }
    html[data-theme="dark"],
    body[data-theme="dark"] {
      --bg: #000000;
      --bg2: #0b121b;
      --surface: #111a25;
      --surface2: #172234;
      --text: #d5e1f2;
      --text-strong: #e2ecfb;
      --muted: #8ea4bf;
      --line: #2b3f57;
      --accent: #5b9bd1;
      --ok: #4ebd8a;
      --warn: #d39a49;
      --pending: #5f7288;
      --danger: #d06f6f;
      --dock-bg: #000000;
      --dock-surface: #141f2f;
      --dock-line: #2c4058;
      --shadow: 0 14px 30px rgba(0, 0, 0, 0.5);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      min-height: 100%;
      font-family: "BIZ UDPGothic", "Yu Gothic UI", "Meiryo", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 120% -10%, var(--bg2), transparent 55%),
        radial-gradient(800px 500px at -20% 20%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 55%),
        var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    body {
      padding-bottom: 110px;
    }
    .wrap { width: min(1100px, 94vw); margin: 14px auto 36px; }
    .header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--surface) 88%, transparent);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }
    h1 { margin: 0; font-size: clamp(1.5rem, 3vw, 1.8rem); }
    .sub { margin: 2px 0 0; color: var(--muted); font-size: .84rem; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      min-height: var(--tap);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 14px;
      background: var(--surface2);
      color: var(--text);
      font-size: .95rem;
      font-weight: 700;
      cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--accent); color: var(--text-strong); border-color: color-mix(in srgb, var(--accent) 70%, black); }
    .btn.warn { background: color-mix(in srgb, var(--warn) 22%, var(--surface)); }
    .btn.danger { background: color-mix(in srgb, var(--danger) 20%, var(--surface)); }
    .panel {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 16%, var(--surface)), var(--surface));
      font-weight: 700;
    }
    .panel-body { padding: 12px; }
    #truckScreen .panel {
      margin-top: 0;
      border: none;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
      overflow: visible;
    }
    #truckScreen .panel-body {
      padding: 0;
    }
    #exportScreen .panel {
      background: var(--surface2);
    }
    .export-body {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: var(--surface2);
    }
    .export-note-field {
      padding: 10px 10px 8px;
    }
    .field.export-note-field textarea {
      min-height: 393.3px;
    }
    .export-actions {
      padding: 0 10px 10px;
    }
    .meta {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      align-items: end;
    }
    .basic-meta {
      grid-template-areas:
        "date vehicle mode"
        "driver vehicle mode";
    }
    .basic-meta .field-date { grid-area: date; }
    .basic-meta .field-driver { grid-area: driver; }
    .basic-meta .field-vehicle { grid-area: vehicle; }
    .basic-meta .field-mode { grid-area: mode; }
    .field { display: grid; gap: 6px; }
    .field label { font-size: .84rem; color: var(--muted); font-weight: 700; }
    .export-note-field > label { font-size: 1rem; color: var(--text); font-weight: 700; }
    .field input,
    .field select,
    .field textarea {
      min-height: var(--tap);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 1rem;
      color: var(--text);
      background: var(--surface2);
      width: 100%;
    }
    .field textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }
    .mode-switch {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .mode-btn {
      min-height: 54px;
      padding: 8px 10px;
      font-size: .9rem;
    }
    .mode-btn.active {
      background: var(--accent);
      color: var(--text-strong);
      border-color: color-mix(in srgb, var(--accent) 70%, black);
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr minmax(170px, 2fr) 1fr;
      grid-template-rows: 1fr auto;
      gap: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--surface2);
      padding: 12px;
    }
    .col {
      display: grid;
      gap: 10px;
      align-content: stretch;
    }
    .tire-slot {
      display: flex;
      align-items: stretch;
      height: 100%;
    }
    .tire-slot.single {
      justify-content: center;
    }
    .tire-slot.single .tire {
      width: calc(50% - 4px);
    }
    .tire-slot.dual {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .truck {
      border: 2px solid color-mix(in srgb, var(--accent) 45%, var(--line));
      border-radius: 14px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 18%, var(--surface)), var(--surface));
      display: grid;
      padding: 8px;
    }
    .ax {
      border-bottom: 1px dashed color-mix(in srgb, var(--line) 70%, transparent);
      color: var(--muted);
      font-size: .82rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ax:last-child { border-bottom: none; }
    .tire {
      min-height: 62px;
      width: 100%;
      border-radius: 12px;
      border: 1px solid transparent;
      background: color-mix(in srgb, var(--pending) 40%, var(--surface2));
      color: color-mix(in srgb, var(--text) 86%, black);
      font-size: 1.02rem;
      font-weight: 800;
      cursor: pointer;
    }
    .tire.partial { background: color-mix(in srgb, var(--warn) 34%, var(--surface2)); border-color: color-mix(in srgb, var(--warn) 70%, var(--line)); }
    .tire.done { background: color-mix(in srgb, var(--ok) 35%, var(--surface2)); border-color: color-mix(in srgb, var(--ok) 70%, var(--line)); }
    .spare {
      grid-column: 2;
      width: 100%;
      align-self: start;
      display: flex;
      justify-content: center;
    }
    .spare .tire {
      width: calc(50% - 4px);
    }
    .muted { color: var(--muted); font-size: .84rem; }
    .summary {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--surface2);
      padding: 10px;
      min-height: 105px;
    }
    .card.pending { border-style: dashed; }
    .card h3 { margin: 0; font-size: .98rem; }
    .card p { margin: 8px 0 0; font-size: .87rem; line-height: 1.45; }
    .screen { display: none; }
    .screen.active { display: block; }
    .screen-actions {
      margin-top: 12px;
      justify-content: center;
    }
    .screen-actions .btn {
      flex: 1 1 220px;
    }
    .truck-actions {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }
    .truck-actions .btn {
      width: 100%;
      min-height: 68px;
      font-size: 1.02rem;
    }
    .send-btn {
      flex: 1 1 100%;
      width: 100%;
      min-height: 68px;
      font-size: 1.05rem;
    }
    .fixed-settings {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 40;
      display: flex;
      justify-content: center;
      padding: 10px 0 calc(12px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, transparent 0%, color-mix(in srgb, var(--dock-bg) 88%, black) 36%);
      pointer-events: none;
    }
    .fixed-settings-row {
      width: min(520px, 92vw);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: color-mix(in srgb, var(--dock-surface) 90%, black);
      border-color: var(--dock-line);
      box-shadow: var(--shadow);
      pointer-events: auto;
    }
    .fixed-settings .btn {
      width: 100%;
      pointer-events: auto;
      box-shadow: none;
    }
    body.screen-settings .fixed-settings {
      display: none;
    }
    .settings-body {
      display: grid;
      gap: 12px;
    }
    .empty { color: var(--muted); font-size: .92rem; }
    body.screen-truck .wrap {
      width: min(1320px, 98vw);
    }
    body.screen-truck #truckScreen .panel-body {
      min-height: calc(100vh - 230px);
      display: flex;
      flex-direction: column;
    }
    body.screen-truck #truckScreen .layout {
      flex: 1;
    }
    .vehicle-list {
      display: grid;
      gap: 8px;
      max-height: 220px;
      overflow: auto;
      padding-right: 2px;
    }
    .vehicle-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--surface2);
      padding: 8px 10px;
    }
    .vehicle-item span {
      font-size: .92rem;
      font-weight: 700;
      word-break: break-all;
    }
    .mini-btn {
      min-height: 42px;
      padding: 8px 12px;
      font-size: .85rem;
      font-weight: 700;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: color-mix(in srgb, var(--danger) 18%, var(--surface));
      color: var(--text);
      cursor: pointer;
      white-space: nowrap;
    }
    dialog {
      border: none;
      width: min(92vw, 420px);
      padding: 0;
      background: transparent;
    }
    dialog::backdrop { background: rgba(7, 13, 22, .52); }
    .modal {
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: var(--surface);
      box-shadow: var(--shadow);
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 16%, var(--surface)), var(--surface));
    }
    .modal-body { padding: 12px; display: grid; gap: 10px; }
    .step { color: var(--muted); font-size: .88rem; font-weight: 700; }
    .modal h3 { margin: 0; font-size: 1rem; }
    .confirm-text {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 800;
      text-align: center;
      color: var(--text);
      padding: 8px 4px;
    }
    #sendConfirmDialog .modal-foot {
      justify-content: center;
      gap: 10px;
    }
    #sendConfirmDialog .modal-foot .btn {
      flex: 1 1 0;
      min-width: 0;
    }
    #inputDialog .modal-head {
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 86%, black), color-mix(in srgb, var(--accent) 62%, black));
    }
    #inputDialog .modal-body {
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 70%, #0b1c2f), color-mix(in srgb, var(--accent) 55%, #0b1c2f));
    }
    #inputDialog #dialogTarget {
      color: var(--text-strong);
      font-size: 1.2rem;
      font-weight: 800;
    }
    #inputDialog #stepTitle {
      color: var(--text-strong);
      font-size: 1.2rem;
      font-weight: 800;
    }
    #inputDialog .preview {
      color: var(--text-strong);
      font-size: 1rem;
      border-color: color-mix(in srgb, var(--line) 55%, transparent);
      background: color-mix(in srgb, var(--surface2) 18%, #0f2237);
    }
    .sel {
      min-height: var(--tap);
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--surface2);
      color: var(--text);
      font-size: 1rem;
      font-weight: 700;
      padding: 8px 10px;
    }
    .preview {
      margin: 0;
      min-height: 42px;
      border: 1px dashed var(--line);
      border-radius: 10px;
      background: color-mix(in srgb, var(--surface2) 70%, transparent);
      padding: 8px 10px;
      color: var(--muted);
      font-size: .88rem;
      line-height: 1.4;
      white-space: pre-line;
    }
    .preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: start;
    }
    .preview-col {
      display: grid;
      gap: 4px;
    }
    .preview-label {
      margin: 0;
      min-height: 1.1em;
      font-size: .76rem;
      color: var(--muted);
      font-weight: 700;
      padding-left: 2px;
    }
    .preview-prev {
      color: color-mix(in srgb, var(--text) 62%, var(--muted));
      background: color-mix(in srgb, var(--surface2) 45%, transparent);
      border-color: color-mix(in srgb, var(--line) 70%, transparent);
    }
    .modal-foot {
      padding: 12px;
      border-top: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    #inputDialog .modal-foot {
      justify-content: flex-start;
    }
    #inputDialog #closeStepBtn {
      margin-left: auto;
    }
    #inputDialog .modal {
      position: relative;
    }
    .input-warning {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(.96);
      opacity: 0;
      pointer-events: none;
      width: min(88vw, 760px);
      background: color-mix(in srgb, var(--danger) 88%, black);
      color: var(--text-strong);
      border: 1px solid color-mix(in srgb, var(--accent) 40%, var(--line));
      border-radius: 20px;
      padding: 14px 18px;
      font-size: 2.25rem;
      line-height: 1.15;
      font-weight: 800;
      text-align: center;
      overflow-wrap: anywhere;
      z-index: 40;
      transition: opacity .15s ease, transform .15s ease;
    }
    .input-warning.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(86px + env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(16px);
      opacity: 0;
      pointer-events: none;
      width: min(96vw, 1200px);
      background: color-mix(in srgb, var(--danger) 88%, black);
      color: var(--text-strong);
      border: 1px solid color-mix(in srgb, var(--accent) 40%, var(--line));
      border-radius: 24px;
      padding: 18px 24px;
      font-size: 4.5rem;
      line-height: 1.15;
      text-align: center;
      white-space: normal;
      overflow-wrap: anywhere;
      z-index: 30;
      transition: opacity .15s ease, transform .15s ease;
    }
    .toast.warn {
      width: min(92vw, 760px);
      border-radius: 20px;
      padding: 14px 18px;
      font-size: 2.25rem;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    @media (max-width: 860px) {
      .header { position: static; }
      .meta { grid-template-columns: 1fr; }
      .basic-meta { grid-template-areas: none; }
      .basic-meta .field-date,
      .basic-meta .field-driver,
      .basic-meta .field-vehicle,
      .basic-meta .field-mode { grid-area: auto; }
      .layout { grid-template-columns: 1fr minmax(130px, 1.2fr) 1fr; grid-template-rows: 1fr auto; gap: 8px; }
      .tire { min-height: 58px; }
      .screen-actions .btn { flex-basis: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div>
        <h1>月次タイヤ点検表</h1>
      </div>
      <div class="row">
      </div>
    </header>

    <section id="basicScreen" class="screen active">
      <section class="panel">
        <div class="panel-head">基本情報</div>
        <div class="panel-body">
          <div class="meta basic-meta">
            <div class="field field-date">
              <label for="inspectionDate">点検日</label>
              <input id="inspectionDate" type="date">
            </div>
            <div class="field field-driver">
              <label for="driverName">乗務員</label>
              <select id="driverName">
                <option value="">選択してください</option>
              </select>
            </div>
            <div class="field field-vehicle">
              <label for="vehicleNumber">車両番号</label>
              <select id="vehicleNumber">
                <option value="">選択してください</option>
              </select>
            </div>
            <div class="field field-mode">
              <label for="truckType">車種</label>
              <select id="truckType">
                <option value="">選択してください</option>
              </select>
            </div>
          </div>
        </div>
      </section>
      <div class="row screen-actions">
        <button id="basicNextBtn" class="btn primary" type="button">点検開始</button>
      </div>
    </section>

    <section id="truckScreen" class="screen">
      <section class="panel">
        <div class="panel-body">
          <div class="layout" role="group" aria-label="タイヤ入力">
            <div id="leftTires" class="col"></div>
            <div id="truckAxes" class="truck"></div>
            <div id="rightTires" class="col"></div>
            <div class="spare">
              <button id="spareButton" class="tire" type="button">スペア</button>
            </div>
          </div>
          <div class="truck-actions">
            <button id="truckToExportBtn" class="btn primary" type="button">点検完了</button>
            <button id="truckBackBtn" class="btn" type="button">基本情報へ戻る</button>
            <!-- TEMP: 前回データ一括反映（不要になったらこのボタンと関連JSを削除） -->
            <button id="applyPreviousBtn" class="btn" type="button">前回データをそのまま入力</button>
          </div>
        </div>
      </section>
    </section>

    <section id="exportScreen" class="screen">
      <section class="panel">
        <div class="panel-body export-body">
          <p id="exportSummary" class="empty"></p>
          <div class="field export-note-field">
            <label for="reportNote">報告事項</label>
            <textarea id="reportNote" placeholder="報告事項を入力"></textarea>
          </div>
          <div class="row export-actions">
            <button id="exportCsvBtn" class="btn primary send-btn" type="button">専務に送る</button>
            <button id="exportBackBtn" class="btn send-btn" type="button">修正する</button>
          </div>
        </div>
      </section>
    </section>

    <section id="settingsScreen" class="screen">
      <section class="panel">
        <div class="panel-head">設定</div>
        <div class="panel-body settings-body">
          <div class="field">
            <label for="themeMode">表示モード</label>
            <select id="themeMode" class="sel">
              <option value="light">ライトモード</option>
              <option value="dark">ダークモード</option>
            </select>
          </div>
          <div class="field">
            <label for="newVehicleNumber">車両番号を登録</label>
            <div class="row">
              <input id="newVehicleNumber" type="text" placeholder="例: 品川 100 あ 1234" autocomplete="off">
              <button id="addVehicleBtn" class="btn primary" type="button">登録</button>
            </div>
          </div>
          <div class="field">
            <label>登録済み車両番号</label>
            <div id="vehicleList" class="vehicle-list"></div>
          </div>
          <div class="field">
            <label for="newDriverName">乗務員を登録</label>
            <div class="row">
              <input id="newDriverName" type="text" placeholder="例: 山田 太郎" autocomplete="off">
              <button id="addDriverBtn" class="btn primary" type="button">登録</button>
            </div>
          </div>
          <div class="field">
            <label>登録済み乗務員</label>
            <div id="driverList" class="vehicle-list"></div>
          </div>
          <div class="field">
            <label for="newTruckType">車種を登録</label>
            <div class="row">
              <select id="newTruckType" class="sel"></select>
              <button id="addTruckTypeBtn" class="btn primary" type="button">登録</button>
            </div>
          </div>
          <div class="field">
            <label>登録済み車種</label>
            <div id="truckTypeList" class="vehicle-list"></div>
          </div>
        </div>
      </section>
      <div class="row screen-actions">
        <button id="closeSettingsBtn" class="btn primary" type="button">戻る</button>
      </div>
    </section>
  </div>

  <div class="fixed-settings">
    <div class="fixed-settings-row">
      <button id="quickResetBtn" class="btn" type="button">リセット</button>
      <button id="openSettingsBtn" class="btn" type="button">設定</button>
    </div>
  </div>

  <dialog id="inputDialog" aria-label="タイヤ入力">
    <div class="modal">
      <div class="modal-head">
        <h3 id="dialogTarget">タイヤ入力</h3>
        <button id="dialogCloseBtn" class="btn" type="button" style="min-height:auto;padding:6px 10px;">閉じる</button>
      </div>
      <div class="modal-body">
        <div id="stepIndicator" class="step"></div>
        <h3 id="stepTitle"></h3>
        <select id="stepSelect" class="sel"></select>
        <div class="field">
          <label>入力内容一覧</label>
          <div class="preview-grid">
            <div class="preview-col">
              <p class="preview-label">現在</p>
              <p id="stepPreview" class="preview"></p>
            </div>
            <div class="preview-col">
              <p class="preview-label">前回</p>
              <p id="prevStepPreview" class="preview preview-prev"></p>
            </div>
          </div>
        </div>
      </div>
      <div id="inputWarning" class="input-warning" role="alert" aria-live="assertive"></div>
      <div class="modal-foot">
        <button id="prevStepBtn" class="btn" type="button">前の項目</button>
        <button id="nextStepBtn" class="btn" type="button">次の項目</button>
        <button id="closeStepBtn" class="btn primary" type="button">完了</button>
      </div>
    </div>
  </dialog>

  <dialog id="sendConfirmDialog" aria-label="送信確認">
    <div class="modal">
      <div class="modal-head">
        <h3>送信確認</h3>
      </div>
      <div class="modal-body">
        <p class="confirm-text">間違いはありませんか？</p>
      </div>
      <div class="modal-foot">
        <button id="sendFixBtn" class="btn" type="button">修正</button>
        <button id="sendSubmitBtn" class="btn primary" type="button">送信</button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script src="./firebase/firebase-config.js?v=20260221"></script>
  <script src="./firebase/firebase-cloud-sync.js?v=20260221"></script>
  <script>
    (() => {
      "use strict";

      const STORAGE = {
        current: "tire.monthly.current.v1",
        previous: "tire.monthly.previous.v1",
        vehicles: "tire.monthly.vehicles.v1",
        drivers: "tire.monthly.drivers.v1",
        truckTypes: "tire.monthly.trucktypes.v1",
        theme: "tire.monthly.theme.v1"
      };

      const TRUCK_TYPES = {
        LOW12: "low12",
        TEN10: "ten10"
      };
      const TRUCK_TYPE_CATALOG = [
        { value: TRUCK_TYPES.LOW12, label: "大型低床" },
        { value: TRUCK_TYPES.TEN10, label: "大型10輪" }
      ];
      const FLOW_SCREENS = {
        BASIC: "basic",
        TRUCK: "truck",
        EXPORT: "export",
        SETTINGS: "settings"
      };

      const DISPLAY_MAP_12 = ["①", "⑦", "②", "⑧", "③", "⑨", "④", "⑩", "⑤", "⑪", "⑥", "⑫"];
      const DISPLAY_MAP_10 = ["①", "⑥", "②", "⑦", "③", "⑧", "④", "⑨", "⑤", "⑩"];
      const ALL_IDS = Array.from({ length: 12 }, (_, i) => i + 1);

      const TRUCK_LAYOUTS = {
        [TRUCK_TYPES.LOW12]: {
          left: [[1], [3], [5, 7], [9, 11]],
          right: [[2], [4], [6, 8], [10, 12]],
          axes: ["前輪", "2軸", "3軸", "4軸"]
        },
        [TRUCK_TYPES.TEN10]: {
          left: [[1], [3, 5], [7, 9]],
          right: [[2], [4, 6], [8, 10]],
          axes: ["前輪", "2軸", "3軸"]
        }
      };

      const NORMAL_FIELDS = [
        { key: "maker", label: "メーカー", options: ["ミシュラン", "サイルン", "チャオヤン", "トーヨー", "ジンユー"] },
        { key: "type", label: "種類", options: ["ノーマル", "スタッドレス", "再生", "リグ"] },
        { key: "groove", label: "溝", options: ["○", "△", "✕"] },
        { key: "wear", label: "偏摩耗", options: ["○", "△", "✕"] },
        { key: "damage", label: "キズ", options: ["○", "✕"] },
        { key: "pressure", label: "空気圧", options: ["○", "✕"] }
      ];

      const SPARE_FIELDS = [
        { key: "maker", label: "メーカー", options: ["ミシュラン", "サイルン", "チャオヤン", "トーヨー", "ジンユー"] },
        { key: "type", label: "種類", options: ["ノーマル", "スタッドレス", "再生", "リグ"] },
        { key: "condition", label: "状態", options: ["○", "△", "✕"] }
      ];

      const el = {
        basicScreen: document.getElementById("basicScreen"),
        truckScreen: document.getElementById("truckScreen"),
        exportScreen: document.getElementById("exportScreen"),
        settingsScreen: document.getElementById("settingsScreen"),
        inspectionDate: document.getElementById("inspectionDate"),
        driverName: document.getElementById("driverName"),
        vehicleNumber: document.getElementById("vehicleNumber"),
        truckType: document.getElementById("truckType"),
        basicNextBtn: document.getElementById("basicNextBtn"),
        leftTires: document.getElementById("leftTires"),
        rightTires: document.getElementById("rightTires"),
        truckAxes: document.getElementById("truckAxes"),
        spareButton: document.getElementById("spareButton"),
        truckBackBtn: document.getElementById("truckBackBtn"),
        applyPreviousBtn: document.getElementById("applyPreviousBtn"),
        truckToExportBtn: document.getElementById("truckToExportBtn"),
        exportCsvBtn: document.getElementById("exportCsvBtn"),
        exportBackBtn: document.getElementById("exportBackBtn"),
        quickResetBtn: document.getElementById("quickResetBtn"),
        openSettingsBtn: document.getElementById("openSettingsBtn"),
        exportSummary: document.getElementById("exportSummary"),
        reportNote: document.getElementById("reportNote"),
        inputDialog: document.getElementById("inputDialog"),
        dialogTarget: document.getElementById("dialogTarget"),
        dialogCloseBtn: document.getElementById("dialogCloseBtn"),
        stepIndicator: document.getElementById("stepIndicator"),
        stepTitle: document.getElementById("stepTitle"),
        stepSelect: document.getElementById("stepSelect"),
        stepPreview: document.getElementById("stepPreview"),
        prevStepPreview: document.getElementById("prevStepPreview"),
        prevStepBtn: document.getElementById("prevStepBtn"),
        nextStepBtn: document.getElementById("nextStepBtn"),
        closeStepBtn: document.getElementById("closeStepBtn"),
        inputWarning: document.getElementById("inputWarning"),
        closeSettingsBtn: document.getElementById("closeSettingsBtn"),
        sendConfirmDialog: document.getElementById("sendConfirmDialog"),
        sendFixBtn: document.getElementById("sendFixBtn"),
        sendSubmitBtn: document.getElementById("sendSubmitBtn"),
        themeMode: document.getElementById("themeMode"),
        newVehicleNumber: document.getElementById("newVehicleNumber"),
        addVehicleBtn: document.getElementById("addVehicleBtn"),
        vehicleList: document.getElementById("vehicleList"),
        newDriverName: document.getElementById("newDriverName"),
        addDriverBtn: document.getElementById("addDriverBtn"),
        driverList: document.getElementById("driverList"),
        newTruckType: document.getElementById("newTruckType"),
        addTruckTypeBtn: document.getElementById("addTruckTypeBtn"),
        truckTypeList: document.getElementById("truckTypeList"),
        toast: document.getElementById("toast")
      };

      const today = () => {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      };
      const normalizeTruckType = (type) => type === TRUCK_TYPES.TEN10 ? TRUCK_TYPES.TEN10 : TRUCK_TYPES.LOW12;
      const truckTypeLabel = (type) => {
        const found = TRUCK_TYPE_CATALOG.find((item) => item.value === type);
        return found ? found.label : truckTypeLabel(normalizeTruckType(type));
      };
      const sortTruckTypes = (rows) => TRUCK_TYPE_CATALOG.map((item) => item.value).filter((value) => rows.includes(value));
      const getLayout = (type) => TRUCK_LAYOUTS[normalizeTruckType(type)];
      const getActiveIds = (type) => {
        const layout = getLayout(type);
        return layout.left.concat(layout.right).flat();
      };
      const displayMapFor = (type) => normalizeTruckType(type) === TRUCK_TYPES.TEN10 ? DISPLAY_MAP_10 : DISPLAY_MAP_12;
      const circle = (id, type = TRUCK_TYPES.LOW12) => displayMapFor(type)[id - 1] || String(id);

      const newTire = () => ({ maker: "", type: "", groove: "", wear: "", damage: "", pressure: "" });
      const newSpare = () => ({ maker: "", type: "", condition: "" });
      const defaultCurrent = () => ({
        truckType: TRUCK_TYPES.LOW12,
        inspectionDate: today(),
        driverName: "",
        vehicleNumber: "",
        reportNote: "",
        tires: Object.fromEntries(ALL_IDS.map((id) => [id, newTire()])),
        spare: newSpare(),
        updatedAt: new Date().toISOString()
      });

      const read = (key, fallback) => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch {
          return fallback;
        }
      };

      const normalizeCurrent = (obj) => {
        const base = defaultCurrent();
        const curr = {
          ...base,
          ...(obj || {}),
          truckType: normalizeTruckType(obj && obj.truckType),
          tires: base.tires,
          spare: { ...base.spare, ...(obj && obj.spare ? obj.spare : {}) }
        };
        ALL_IDS.forEach((id) => {
          curr.tires[id] = { ...newTire(), ...(obj && obj.tires && obj.tires[id] ? obj.tires[id] : {}) };
        });
        curr.driverName = typeof curr.driverName === "string" ? curr.driverName : "";
        curr.reportNote = typeof curr.reportNote === "string" ? curr.reportNote : "";
        if (!curr.inspectionDate) curr.inspectionDate = today();
        if (!curr.updatedAt) curr.updatedAt = new Date().toISOString();
        return curr;
      };
      const normalizePrevious = (obj) => {
        if (!obj || typeof obj !== "object") return null;
        return normalizeCurrent(obj);
      };

      const normalizeVehicles = (rows) => {
        if (!Array.isArray(rows)) return [];
        const uniq = [];
        rows.forEach((item) => {
          const value = String(item ?? "").trim();
          if (!value) return;
          if (!uniq.includes(value)) uniq.push(value);
        });
        return uniq.slice(0, 300);
      };
      const normalizeTruckTypes = (rows) => {
        if (!Array.isArray(rows)) return sortTruckTypes(TRUCK_TYPE_CATALOG.map((item) => item.value));
        const uniq = [];
        rows.forEach((item) => {
          if (!TRUCK_TYPE_CATALOG.some((type) => type.value === item)) return;
          if (!uniq.includes(item)) uniq.push(item);
        });
        const sorted = sortTruckTypes(uniq);
        return sorted.length > 0 ? sorted : sortTruckTypes(TRUCK_TYPE_CATALOG.map((item) => item.value));
      };

      let current = normalizeCurrent(read(STORAGE.current, defaultCurrent()));
      let previous = normalizePrevious(read(STORAGE.previous, null));
      let vehicles = normalizeVehicles(read(STORAGE.vehicles, []));
      let drivers = normalizeVehicles(read(STORAGE.drivers, []));
      let truckTypes = normalizeTruckTypes(read(STORAGE.truckTypes, TRUCK_TYPE_CATALOG.map((item) => item.value)));
      let tireButtons = {};
      let dialog = { target: null, fields: [], step: 0 };
      let currentScreen = FLOW_SCREENS.BASIC;
      let screenBeforeSettings = FLOW_SCREENS.BASIC;
      const SHARE_REASONS = { OK: "ok", CANCEL: "cancel", UNSUPPORTED: "unsupported", ERROR: "error" };
      const CLOUD_SYNC_ON_SUBMIT_ONLY = true;
      const buildCloudPayload = (source = "input") => ({
        source,
        savedAt: new Date().toISOString(),
        current: normalizeCurrent(current),
        previous: previous ? normalizeCurrent(previous) : null,
        vehicles: vehicles.slice(),
        drivers: drivers.slice(),
        truckTypes: truckTypes.slice()
      });
      const scheduleCloudSync = (source = "input") => {
        if (CLOUD_SYNC_ON_SUBMIT_ONLY) return;
        if (!window.FirebaseCloudSync || typeof window.FirebaseCloudSync.schedule !== "function") return;
        window.FirebaseCloudSync.schedule(source);
      };

      const saveCurrent = () => {
        current.updatedAt = new Date().toISOString();
        localStorage.setItem(STORAGE.current, JSON.stringify(current));
        scheduleCloudSync("input");
      };
      const savePrevious = () => {
        if (!previous) {
          localStorage.removeItem(STORAGE.previous);
          scheduleCloudSync("previous");
          return;
        }
        localStorage.setItem(STORAGE.previous, JSON.stringify(previous));
        scheduleCloudSync("previous");
      };
      const saveVehicles = () => {
        localStorage.setItem(STORAGE.vehicles, JSON.stringify(vehicles));
        scheduleCloudSync("master");
      };
      const saveDrivers = () => {
        localStorage.setItem(STORAGE.drivers, JSON.stringify(drivers));
        scheduleCloudSync("master");
      };
      const saveTruckTypes = () => {
        localStorage.setItem(STORAGE.truckTypes, JSON.stringify(truckTypes));
        scheduleCloudSync("master");
      };

      function cleanupLegacyExportDirectoryStorage() {
        localStorage.removeItem("tire.monthly.export.dirname.v1");
        if (!("indexedDB" in window)) return;
        try {
          indexedDB.deleteDatabase("tire.monthly.fs.v1");
        } catch {
          // noop
        }
      }

      if (current.vehicleNumber && !vehicles.includes(current.vehicleNumber)) {
        vehicles.unshift(current.vehicleNumber);
        saveVehicles();
      }
      if (current.driverName && !drivers.includes(current.driverName)) {
        drivers.unshift(current.driverName);
        saveDrivers();
      }
      if (!truckTypes.includes(current.truckType)) {
        current.truckType = truckTypes[0] || TRUCK_TYPES.LOW12;
        saveCurrent();
      }

      const fillCount = (obj, fields) => fields.reduce((sum, f) => sum + (obj[f.key] ? 1 : 0), 0);
      const totalCount = () => getActiveIds(current.truckType).reduce((sum, id) => sum + fillCount(current.tires[id], NORMAL_FIELDS), 0) + fillCount(current.spare, SPARE_FIELDS);
      const percent = () => {
        const totalFields = getActiveIds(current.truckType).length * NORMAL_FIELDS.length + SPARE_FIELDS.length;
        return Math.round((totalCount() / totalFields) * 100);
      };

      const tireClass = (id) => {
        const c = fillCount(current.tires[id], NORMAL_FIELDS);
        if (c === 0) return "";
        if (c === NORMAL_FIELDS.length) return "done";
        return "partial";
      };
      const spareClass = () => {
        const c = fillCount(current.spare, SPARE_FIELDS);
        if (c === 0) return "";
        if (c === SPARE_FIELDS.length) return "done";
        return "partial";
      };

      const text = (v) => v || "未入力";

      function renderScreens() {
        const basic = currentScreen === FLOW_SCREENS.BASIC;
        const truck = currentScreen === FLOW_SCREENS.TRUCK;
        const exp = currentScreen === FLOW_SCREENS.EXPORT;
        const settings = currentScreen === FLOW_SCREENS.SETTINGS;

        el.basicScreen.classList.toggle("active", basic);
        el.truckScreen.classList.toggle("active", truck);
        el.exportScreen.classList.toggle("active", exp);
        el.settingsScreen.classList.toggle("active", settings);
        document.body.classList.toggle("screen-truck", truck);
        document.body.classList.toggle("screen-settings", settings);
      }

      function renderExportSummary() {
        el.exportSummary.textContent = "";
        el.exportSummary.style.display = "none";
      }

      function renderReportNote() {
        const note = current.reportNote || "";
        if (el.reportNote.value !== note) el.reportNote.value = note;
      }

      function renderButtons() {
        getActiveIds(current.truckType).forEach((id) => {
          if (!tireButtons[id]) return;
          tireButtons[id].className = `tire ${tireClass(id)}`.trim();
        });
        el.spareButton.className = `tire ${spareClass()}`.trim();
        if (el.applyPreviousBtn) el.applyPreviousBtn.disabled = !previous;
      }

      function renderDriverNameSelect() {
        const selected = current.driverName || "";
        el.driverName.innerHTML = "";
        el.driverName.appendChild(new Option("選択してください", ""));
        drivers.forEach((driver) => {
          el.driverName.appendChild(new Option(driver, driver));
        });
        if (selected && !drivers.includes(selected)) {
          el.driverName.appendChild(new Option(selected, selected));
        }
        el.driverName.value = selected;
      }

      function renderVehicleNumberSelect() {
        const selected = current.vehicleNumber || "";
        el.vehicleNumber.innerHTML = "";
        el.vehicleNumber.appendChild(new Option("選択してください", ""));
        vehicles.forEach((vehicle) => {
          el.vehicleNumber.appendChild(new Option(vehicle, vehicle));
        });
        if (selected && !vehicles.includes(selected)) {
          el.vehicleNumber.appendChild(new Option(selected, selected));
        }
        el.vehicleNumber.value = selected;
      }

      function renderTruckTypeSelect() {
        const selected = normalizeTruckType(current.truckType);
        el.truckType.innerHTML = "";
        el.truckType.appendChild(new Option("選択してください", ""));
        truckTypes.forEach((truckType) => {
          el.truckType.appendChild(new Option(truckTypeLabel(truckType), truckType));
        });
        if (selected && !truckTypes.includes(selected)) {
          el.truckType.appendChild(new Option(truckTypeLabel(selected), selected));
        }
        el.truckType.value = selected;
      }

      function renderVehicleList() {
        el.vehicleList.innerHTML = "";
        if (vehicles.length === 0) {
          el.vehicleList.innerHTML = '<div class="empty">登録済み車両番号はありません。</div>';
          return;
        }

        vehicles.forEach((vehicle) => {
          const row = document.createElement("div");
          row.className = "vehicle-item";

          const label = document.createElement("span");
          label.textContent = vehicle;

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "mini-btn";
          remove.textContent = "削除";
          remove.dataset.vehicle = vehicle;

          row.appendChild(label);
          row.appendChild(remove);
          el.vehicleList.appendChild(row);
        });
      }

      function renderDriverList() {
        el.driverList.innerHTML = "";
        if (drivers.length === 0) {
          el.driverList.innerHTML = '<div class="empty">登録済み乗務員はありません。</div>';
          return;
        }

        drivers.forEach((driver) => {
          const row = document.createElement("div");
          row.className = "vehicle-item";

          const label = document.createElement("span");
          label.textContent = driver;

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "mini-btn";
          remove.textContent = "削除";
          remove.dataset.driver = driver;

          row.appendChild(label);
          row.appendChild(remove);
          el.driverList.appendChild(row);
        });
      }

      function renderTruckTypeCatalogSelect() {
        const options = TRUCK_TYPE_CATALOG.filter((item) => !truckTypes.includes(item.value));
        el.newTruckType.innerHTML = "";
        if (options.length === 0) {
          el.newTruckType.appendChild(new Option("登録可能な車種はありません", ""));
          el.newTruckType.value = "";
          el.addTruckTypeBtn.disabled = true;
          return;
        }
        el.newTruckType.appendChild(new Option("選択してください", ""));
        options.forEach((item) => {
          el.newTruckType.appendChild(new Option(item.label, item.value));
        });
        el.newTruckType.value = "";
        el.addTruckTypeBtn.disabled = false;
      }

      function renderTruckTypeList() {
        el.truckTypeList.innerHTML = "";
        if (truckTypes.length === 0) {
          el.truckTypeList.innerHTML = '<div class="empty">登録済み車種はありません。</div>';
          return;
        }
        truckTypes.forEach((truckType) => {
          const row = document.createElement("div");
          row.className = "vehicle-item";

          const label = document.createElement("span");
          label.textContent = truckTypeLabel(truckType);

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "mini-btn";
          remove.textContent = "削除";
          remove.dataset.truckType = truckType;

          row.appendChild(label);
          row.appendChild(remove);
          el.truckTypeList.appendChild(row);
        });
      }

      function renderSettings() {
        const mode = document.body.getAttribute("data-theme") === "dark" ? "dark" : "light";
        el.themeMode.value = mode;
        renderVehicleList();
        renderDriverList();
        renderTruckTypeCatalogSelect();
        renderTruckTypeList();
      }

      function renderMeta() {
        el.inspectionDate.value = current.inspectionDate;
        renderDriverNameSelect();
        renderVehicleNumberSelect();
        renderTruckTypeSelect();
      }

      function renderAll() {
        renderMeta();
        renderSettings();
        renderScreens();
        renderExportSummary();
        renderReportNote();
        renderButtons();
      }

      function setFlowScreen(screen) {
        closeDialog();
        currentScreen = screen;
        renderAll();
      }

      function isBasicInfoReady() {
        if (!current.inspectionDate) return false;
        if (!current.driverName) return false;
        if (!current.vehicleNumber) return false;
        return true;
      }

      function isInspectionComplete() {
        return percent() === 100;
      }

      const firstUnfilled = (obj, fields) => {
        const i = fields.findIndex((f) => !obj[f.key]);
        return i >= 0 ? i : 0;
      };

      function openDialog(type, id = null) {
        const spare = type === "spare";
        dialog = {
          target: spare ? "spare" : id,
          fields: spare ? SPARE_FIELDS : NORMAL_FIELDS,
          step: 0
        };
        const obj = spare ? current.spare : current.tires[id];
        dialog.step = firstUnfilled(obj, dialog.fields);
        el.dialogTarget.textContent = spare ? "スペアタイヤ入力" : `${circle(id, current.truckType)} タイヤ入力`;
        el.inputWarning.classList.remove("show");
        renderStep();
        if (typeof el.inputDialog.showModal === "function") el.inputDialog.showModal();
        else el.inputDialog.setAttribute("open", "");
      }

      function closeDialog() {
        el.inputWarning.classList.remove("show");
        if (el.inputDialog.open && typeof el.inputDialog.close === "function") el.inputDialog.close();
        else el.inputDialog.removeAttribute("open");
      }

      function hasDialogUnfilled() {
        if (!el.inputDialog.open) return false;
        if (!dialog || !Array.isArray(dialog.fields) || dialog.fields.length === 0) return false;
        const obj = targetObj();
        if (!obj) return false;
        return dialog.fields.some((f) => !obj[f.key]);
      }

      function tryCloseInputDialog() {
        if (!hasDialogUnfilled()) {
          closeDialog();
          return true;
        }
        dialog.step = firstUnfilled(targetObj(), dialog.fields);
        renderStep();
        showToast("未入力があります");
        return false;
      }

      function openSettingsDialog() {
        screenBeforeSettings = currentScreen;
        renderSettings();
        setFlowScreen(FLOW_SCREENS.SETTINGS);
      }

      function closeSettingsDialog() {
        const backTo = screenBeforeSettings === FLOW_SCREENS.SETTINGS ? FLOW_SCREENS.BASIC : screenBeforeSettings;
        setFlowScreen(backTo);
      }

      function openSendConfirmDialog() {
        if (typeof el.sendConfirmDialog.showModal === "function") el.sendConfirmDialog.showModal();
        else el.sendConfirmDialog.setAttribute("open", "");
      }

      function closeSendConfirmDialog() {
        if (el.sendConfirmDialog.open && typeof el.sendConfirmDialog.close === "function") el.sendConfirmDialog.close();
        else el.sendConfirmDialog.removeAttribute("open");
      }
      const targetObj = () => dialog.target === "spare" ? current.spare : current.tires[dialog.target];
      const previousTargetObj = () => {
        if (!previous) return null;
        return dialog.target === "spare" ? previous.spare : previous.tires[dialog.target];
      };

      function renderStep() {
        const obj = targetObj();
        const prevObj = previousTargetObj();
        const field = dialog.fields[dialog.step];
        const promptText = "選択してください";
        el.stepIndicator.textContent = "";
        el.stepTitle.textContent = field.label;
        el.stepSelect.innerHTML = [`<option value="">${promptText}</option>`]
          .concat(field.options.map((v) => `<option value="${v}">${v}</option>`))
          .join("");
        // Always reset to placeholder so selecting the same value can still trigger `change`.
        el.stepSelect.value = "";
        el.stepPreview.textContent = dialog.fields.map((f) => `${f.label}: ${text(obj[f.key])}`).join("\n");
        el.prevStepPreview.textContent = prevObj
          ? dialog.fields.map((f) => `${f.label}: ${text(prevObj[f.key])}`).join("\n")
          : "前回データなし";
        el.prevStepBtn.disabled = dialog.step === 0;
        el.nextStepBtn.disabled = dialog.step >= dialog.fields.length - 1;
        requestAnimationFrame(() => el.stepSelect.focus());
      }

      function applyStep(value) {
        if (!value) return;
        const obj = targetObj();
        const field = dialog.fields[dialog.step];
        obj[field.key] = value;
        saveCurrent();
        renderAll();
        if (dialog.step < dialog.fields.length - 1) {
          dialog.step += 1;
          renderStep();
          return;
        }
        if (hasDialogUnfilled()) {
          dialog.step = firstUnfilled(obj, dialog.fields);
          renderStep();
          showToast("未入力があります");
          return;
        }
        closeDialog();
      }

      function showInputWarning(message) {
        if (!el.inputDialog.open) return false;
        el.inputWarning.textContent = message;
        el.inputWarning.classList.add("show");
        clearTimeout(showInputWarning.tid);
        showInputWarning.tid = setTimeout(() => el.inputWarning.classList.remove("show"), 1800);
        return true;
      }

      function showToast(message) {
        const text = String(message ?? "");
        const isMissingWarning = text.includes("未入力");
        if (isMissingWarning && showInputWarning(text)) {
          el.toast.classList.remove("show");
          return;
        }
        el.toast.classList.toggle("warn", isMissingWarning);
        el.toast.textContent = text;
        el.toast.classList.add("show");
        clearTimeout(showToast.tid);
        showToast.tid = setTimeout(() => el.toast.classList.remove("show"), 1800);
      }

      function snapshot() {
        return {
          savedAt: new Date().toISOString(),
          completion: percent(),
          data: normalizeCurrent(JSON.parse(JSON.stringify(current)))
        };
      }

      function esc(v) {
        const s = String(v ?? "");
        if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }
      function sanitizeFileNamePart(value, fallback = "乗務員未設定") {
        const s = String(value ?? "").trim();
        const cleaned = s
          .replace(/[\\/:*?"<>|\u0000-\u001f]/g, "_")
          .replace(/\s+/g, " ");
        return cleaned || fallback;
      }

      function rowsFor(entry) {
        const d = entry.data;
        const rows = [];
        let sharedWritten = false;
        let noteWritten = false;
        const shared = () => {
          if (sharedWritten) return ["", "", "", ""];
          sharedWritten = true;
          return [entry.savedAt, d.inspectionDate, d.vehicleNumber, d.driverName];
        };
        const report = () => {
          if (noteWritten) return "";
          noteWritten = true;
          return d.reportNote;
        };

        getActiveIds(d.truckType).forEach((id) => {
          const t = d.tires[id];
          rows.push([
            ...shared(),
            circle(id, d.truckType),
            t.maker, t.type, t.groove, t.wear, t.damage, t.pressure, "",
            report()
          ]);
        });
        rows.push([
          ...shared(),
          "スペア",
          d.spare.maker, d.spare.type, "", "", "", "", d.spare.condition,
          report()
        ]);
        return rows;
      }

      async function shareCsvFile(fileName, content) {
        if (typeof navigator.share !== "function") return { ok: false, reason: SHARE_REASONS.UNSUPPORTED };
        if (typeof File !== "function") return { ok: false, reason: SHARE_REASONS.UNSUPPORTED };
        let file;
        try {
          file = new File([content], fileName, { type: "text/csv;charset=utf-8;" });
        } catch {
          return { ok: false, reason: SHARE_REASONS.UNSUPPORTED };
        }
        try {
          if (navigator.canShare && !navigator.canShare({ files: [file] })) {
            return { ok: false, reason: SHARE_REASONS.UNSUPPORTED };
          }
        } catch {
          return { ok: false, reason: SHARE_REASONS.UNSUPPORTED };
        }
        try {
          // iOS互換性を優先して files のみ渡す
          await navigator.share({
            files: [file]
          });
          return { ok: true, reason: SHARE_REASONS.OK };
        } catch (error) {
          if (error && error.name === "AbortError") return { ok: false, reason: SHARE_REASONS.CANCEL };
          console.warn("Share CSV failed:", error);
          return { ok: false, reason: SHARE_REASONS.ERROR };
        }
      }
      function downloadCsv(fileName, content) {
        const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      async function closeApp() {
        try {
          window.close();
        } catch {
          // noop
        }
        await new Promise((resolve) => setTimeout(resolve, 120));
        if (!document.hidden) window.location.replace("about:blank");
      }

      async function exportCsv() {
        const rows = [[
          "保存日時", "点検日", "車両番号", "乗務員", "タイヤ番号", "メーカー", "種類", "溝", "偏摩耗", "キズ", "空気圧", "状態", "報告事項"
        ]];
        const currentEntry = snapshot();
        rows.push(...rowsFor(currentEntry));

        const csv = rows.map((r) => r.map(esc).join(",")).join("\r\n");
        const driverPart = sanitizeFileNamePart(currentEntry.data.driverName);
        const stamp = new Date().toISOString().replace(/[:.]/g, "-");
        const fileName = `月次タイヤ点検_${driverPart}_${stamp}.csv`;
        const content = "\uFEFF" + csv;
        const previousSnapshot = normalizeCurrent(JSON.parse(JSON.stringify(current)));
        if (window.FirebaseCloudSync && typeof window.FirebaseCloudSync.saveNow === "function") {
          await window.FirebaseCloudSync.saveNow("submit");
        }

        const shareResult = await shareCsvFile(fileName, content);
        if (!shareResult.ok) {
          if (shareResult.reason === SHARE_REASONS.CANCEL) {
            showToast("共有がキャンセルされました");
            return;
          }
          downloadCsv(fileName, content);
        }
        previous = previousSnapshot;
        savePrevious();
        resetCurrent({ confirm: false, toast: false });
        await closeApp();
      }

      function resetCurrent(options = {}) {
        const doConfirm = options.confirm !== false;
        const doToast = options.toast !== false;
        if (doConfirm && !window.confirm("現在の入力内容をリセットします。よろしいですか？")) return false;
        const truckType = current.truckType;
        closeDialog();
        current = defaultCurrent();
        current.truckType = truckType;
        if (drivers.length > 0) current.driverName = drivers[0];
        if (vehicles.length > 0) current.vehicleNumber = vehicles[0];
        saveCurrent();
        buildTires();
        currentScreen = FLOW_SCREENS.BASIC;
        renderAll();
        if (doToast) showToast("現在入力をリセットしました");
        return true;
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        document.body.setAttribute("data-theme", theme);
        if (el.themeMode) el.themeMode.value = theme === "dark" ? "dark" : "light";
      }

      function initTheme() {
        const stored = localStorage.getItem(STORAGE.theme);
        if (stored === "dark" || stored === "light") {
          applyTheme(stored);
          return;
        }
        const dark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(dark ? "dark" : "light");
      }

      function setTheme(theme) {
        const next = theme === "dark" ? "dark" : "light";
        localStorage.setItem(STORAGE.theme, next);
        applyTheme(next);
      }

      function setTruckType(type) {
        if (!truckTypes.includes(type)) {
          renderTruckTypeSelect();
          return;
        }
        const next = normalizeTruckType(type);
        if (current.truckType === next) return;
        current.truckType = next;
        saveCurrent();
        closeDialog();
        buildTires();
        renderAll();
      }

      function addVehicleNumber() {
        const value = String(el.newVehicleNumber.value || "").trim();
        if (!value) {
          showToast("車両番号を入力してください");
          return;
        }
        if (vehicles.includes(value)) {
          showToast("同じ車両番号は登録済みです");
          return;
        }

        vehicles.push(value);
        vehicles.sort((a, b) => a.localeCompare(b, "ja"));
        saveVehicles();

        if (!current.vehicleNumber) {
          current.vehicleNumber = value;
          saveCurrent();
        }

        el.newVehicleNumber.value = "";
        renderAll();
        showToast("車両番号を登録しました");
      }

      function removeVehicleNumber(value) {
        const index = vehicles.indexOf(value);
        if (index < 0) return;
        if (!window.confirm(`「${value}」を削除しますか？`)) return;

        vehicles.splice(index, 1);
        saveVehicles();

        if (current.vehicleNumber === value) {
          current.vehicleNumber = vehicles[0] || "";
          saveCurrent();
        }

        renderAll();
        showToast("車両番号を削除しました");
      }

      function addDriverName() {
        const value = String(el.newDriverName.value || "").trim();
        if (!value) {
          showToast("乗務員を入力してください");
          return;
        }
        if (drivers.includes(value)) {
          showToast("同じ乗務員は登録済みです");
          return;
        }

        drivers.push(value);
        drivers.sort((a, b) => a.localeCompare(b, "ja"));
        saveDrivers();

        if (!current.driverName) {
          current.driverName = value;
          saveCurrent();
        }

        el.newDriverName.value = "";
        renderAll();
        showToast("乗務員を登録しました");
      }

      function removeDriverName(value) {
        const index = drivers.indexOf(value);
        if (index < 0) return;
        if (!window.confirm(`「${value}」を削除しますか？`)) return;

        drivers.splice(index, 1);
        saveDrivers();

        if (current.driverName === value) {
          current.driverName = drivers[0] || "";
          saveCurrent();
        }

        renderAll();
        showToast("乗務員を削除しました");
      }

      function addTruckType() {
        const value = String(el.newTruckType.value || "").trim();
        if (!value) {
          showToast("車種を選択してください");
          return;
        }
        if (truckTypes.includes(value)) {
          showToast("同じ車種は登録済みです");
          return;
        }

        truckTypes = sortTruckTypes(truckTypes.concat(value));
        saveTruckTypes();

        if (!truckTypes.includes(current.truckType)) {
          current.truckType = value;
          saveCurrent();
          closeDialog();
          buildTires();
        }

        renderAll();
        showToast("車種を登録しました");
      }

      function removeTruckType(value) {
        const index = truckTypes.indexOf(value);
        if (index < 0) return;
        if (truckTypes.length <= 1) {
          showToast("車種は1件以上登録してください");
          return;
        }
        if (!window.confirm(`「${truckTypeLabel(value)}」を削除しますか？`)) return;

        truckTypes.splice(index, 1);
        truckTypes = sortTruckTypes(truckTypes);
        saveTruckTypes();

        if (current.truckType === value) {
          current.truckType = truckTypes[0] || TRUCK_TYPES.LOW12;
          saveCurrent();
          closeDialog();
          buildTires();
        }

        renderAll();
        showToast("車種を削除しました");
      }

      // TEMP: 前回データ一括反映（不要になったらこの関数ごと削除）
      function applyPreviousSnapshotToCurrent() {
        if (!previous) {
          showToast("前回データがありません");
          return;
        }
        const prevData = normalizeCurrent(previous);
        const active = getActiveIds(current.truckType);
        const activeSet = new Set(active);

        ALL_IDS.forEach((id) => {
          if (!activeSet.has(id)) {
            current.tires[id] = newTire();
            return;
          }
          current.tires[id] = { ...newTire(), ...(prevData.tires[id] || {}) };
        });
        current.spare = { ...newSpare(), ...(prevData.spare || {}) };
        current.reportNote = prevData.reportNote || "";
        saveCurrent();
        closeDialog();
        renderAll();
        showToast("前回データを反映しました");
      }

      function buildTires() {
        const layout = getLayout(current.truckType);
        const rowCount = layout.axes.length;
        const layoutEl = el.leftTires.closest(".layout");
        if (layoutEl) layoutEl.dataset.truckType = current.truckType;

        el.leftTires.innerHTML = "";
        el.rightTires.innerHTML = "";
        el.truckAxes.innerHTML = "";
        el.leftTires.style.gridTemplateRows = `repeat(${rowCount}, minmax(0, 1fr))`;
        el.rightTires.style.gridTemplateRows = `repeat(${rowCount}, minmax(0, 1fr))`;
        el.truckAxes.style.gridTemplateRows = `repeat(${rowCount}, minmax(0, 1fr))`;
        tireButtons = {};

        layout.axes.forEach((label) => {
          const axis = document.createElement("div");
          axis.className = "ax";
          axis.textContent = label;
          el.truckAxes.appendChild(axis);
        });

        const make = (id) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "tire";
          b.textContent = circle(id, current.truckType);
          b.addEventListener("click", () => openDialog("tire", id));
          tireButtons[id] = b;
          return b;
        };

        const appendSide = (container, layout) => {
          layout.forEach((group) => {
            const slot = document.createElement("div");
            slot.className = `tire-slot ${group.length > 1 ? "dual" : "single"}`;
            group.forEach((id) => slot.appendChild(make(id)));
            container.appendChild(slot);
          });
        };

        appendSide(el.leftTires, layout.left);
        appendSide(el.rightTires, layout.right);
      }

      function bindEvents() {
        el.inspectionDate.addEventListener("change", (ev) => {
          if (!ev.target.value) return;
          current.inspectionDate = ev.target.value;
          saveCurrent();
          renderAll();
        });
        el.driverName.addEventListener("change", (ev) => {
          current.driverName = ev.target.value;
          saveCurrent();
          renderAll();
        });
        el.vehicleNumber.addEventListener("change", (ev) => {
          current.vehicleNumber = ev.target.value;
          saveCurrent();
          renderAll();
        });
        el.truckType.addEventListener("change", (ev) => setTruckType(ev.target.value));
        el.basicNextBtn.addEventListener("click", () => {
          if (!isBasicInfoReady()) {
            showToast("基本情報をすべて設定してください");
            return;
          }
          setFlowScreen(FLOW_SCREENS.TRUCK);
        });
        el.truckBackBtn.addEventListener("click", () => setFlowScreen(FLOW_SCREENS.BASIC));
        if (el.applyPreviousBtn) el.applyPreviousBtn.addEventListener("click", applyPreviousSnapshotToCurrent);
        el.truckToExportBtn.addEventListener("click", () => {
          if (!isInspectionComplete()) {
            showToast("未入力があります。すべて入力してください。");
            return;
          }
          setFlowScreen(FLOW_SCREENS.EXPORT);
        });
        el.exportBackBtn.addEventListener("click", () => setFlowScreen(FLOW_SCREENS.TRUCK));
        el.spareButton.addEventListener("click", () => openDialog("spare"));
        el.reportNote.addEventListener("input", (ev) => {
          current.reportNote = ev.target.value;
          saveCurrent();
        });
        el.exportCsvBtn.addEventListener("click", openSendConfirmDialog);
        el.sendFixBtn.addEventListener("click", () => {
          closeSendConfirmDialog();
          setFlowScreen(FLOW_SCREENS.TRUCK);
        });
        el.sendSubmitBtn.addEventListener("click", () => {
          closeSendConfirmDialog();
          void exportCsv();
        });
        el.quickResetBtn.addEventListener("click", resetCurrent);
        el.openSettingsBtn.addEventListener("click", openSettingsDialog);
        el.closeSettingsBtn.addEventListener("click", closeSettingsDialog);
        el.themeMode.addEventListener("change", (ev) => setTheme(ev.target.value));
        el.addVehicleBtn.addEventListener("click", addVehicleNumber);
        el.newVehicleNumber.addEventListener("keydown", (ev) => {
          if (ev.key !== "Enter") return;
          ev.preventDefault();
          addVehicleNumber();
        });
        el.addDriverBtn.addEventListener("click", addDriverName);
        el.newDriverName.addEventListener("keydown", (ev) => {
          if (ev.key !== "Enter") return;
          ev.preventDefault();
          addDriverName();
        });
        el.addTruckTypeBtn.addEventListener("click", addTruckType);
        el.vehicleList.addEventListener("click", (ev) => {
          const target = ev.target;
          if (!(target instanceof HTMLButtonElement)) return;
          const vehicle = target.dataset.vehicle;
          if (!vehicle) return;
          removeVehicleNumber(vehicle);
        });
        el.driverList.addEventListener("click", (ev) => {
          const target = ev.target;
          if (!(target instanceof HTMLButtonElement)) return;
          const driver = target.dataset.driver;
          if (!driver) return;
          removeDriverName(driver);
        });
        el.truckTypeList.addEventListener("click", (ev) => {
          const target = ev.target;
          if (!(target instanceof HTMLButtonElement)) return;
          const truckType = target.dataset.truckType;
          if (!truckType) return;
          removeTruckType(truckType);
        });
        el.dialogCloseBtn.addEventListener("click", closeDialog);
        el.closeStepBtn.addEventListener("click", tryCloseInputDialog);
        el.inputDialog.addEventListener("cancel", (ev) => {
          if (tryCloseInputDialog()) return;
          ev.preventDefault();
        });
        el.prevStepBtn.addEventListener("click", () => {
          if (dialog.step > 0) {
            dialog.step -= 1;
            renderStep();
          }
        });
        el.nextStepBtn.addEventListener("click", () => {
          if (dialog.step < dialog.fields.length - 1) {
            dialog.step += 1;
            renderStep();
          }
        });
        el.stepSelect.addEventListener("change", (ev) => applyStep(ev.target.value));
      }

      async function registerSW() {
        if (!("serviceWorker" in navigator)) return;
        try {
          const registration = await navigator.serviceWorker.register("./sw.js", { updateViaCache: "none" });
          await registration.update();
        } catch (e) {
          console.warn("Service Worker registration failed:", e);
        }
      }

      function init() {
        if (window.FirebaseCloudSync && typeof window.FirebaseCloudSync.init === "function") {
          void window.FirebaseCloudSync.init({
            getPayload: () => buildCloudPayload("autosave")
          });
        }
        cleanupLegacyExportDirectoryStorage();
        initTheme();
        if (!current.inspectionDate) current.inspectionDate = today();
        if (!current.driverName && drivers.length > 0) current.driverName = drivers[0];
        if (!current.vehicleNumber && vehicles.length > 0) current.vehicleNumber = vehicles[0];
        if (!truckTypes.includes(current.truckType)) current.truckType = truckTypes[0] || TRUCK_TYPES.LOW12;
        currentScreen = FLOW_SCREENS.BASIC;
        buildTires();
        bindEvents();
        saveCurrent();
        renderAll();
        registerSW();
      }

      init();
    })();
  </script>
</body>
</html>
